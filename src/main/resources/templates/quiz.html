<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ã‚¯ã‚¤ã‚º | NHK for School</title>
  <style>
    body {
      font-family: "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif;
      background-color: #f5f7fa;
      padding: 30px;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .quiz-container {
      background-color: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .info {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #e7f3ff;
      border-radius: 8px;
    }
    
    .progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    h2 {
      color: #333;
      margin-bottom: 20px;
    }
    
    .question {
      font-size: 1.3em;
      margin-bottom: 25px;
      color: #333;
      font-weight: bold;
      line-height: 1.6;
    }
    
    .choices {
      list-style: none;
      padding: 0;
      margin-bottom: 30px;
    }
    
    .choices li {
      margin-bottom: 12px;
    }
    
    .choices button {
      width: 100%;
      padding: 15px 20px;
      text-align: left;
      border: 2px solid #ddd;
      border-radius: 8px;
      background-color: white;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .choices button:hover:not(:disabled) {
      background-color: #e7f3ff;
      border-color: #0078d7;
      transform: translateX(5px);
    }
    
    .choices button:disabled {
      cursor: not-allowed;
    }
    
    .choices button.correct {
      background-color: #d4edda;
      border-color: #28a745;
      font-weight: bold;
    }
    
    .choices button.wrong {
      background-color: #f8d7da;
      border-color: #dc3545;
    }
    
    .result {
      margin: 20px 0;
      padding: 20px;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: bold;
      text-align: center;
    }
    
    .result.correct {
      background-color: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
    }
    
    .result.wrong {
      background-color: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
    }
    
    /* â˜… Wikidataæƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .wikidata-info {
      margin-top: 20px;
      padding: 20px;
      background-color: #f8f9fa;
      border: 2px solid #0078d7;
      border-radius: 8px;
    }
    
    .wikidata-info h3 {
      color: #0078d7;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.2em;
      display: flex;
      align-items: center;
    }
    
    .wikidata-info h3::before {
      content: "ğŸ“š";
      margin-right: 8px;
    }
    
    .wikidata-info .info-item {
      margin-bottom: 12px;
      line-height: 1.6;
    }
    
    .wikidata-info .info-label {
      font-weight: bold;
      color: #555;
      display: inline-block;
      min-width: 100px;
    }
    
    .wikidata-info .info-value {
      color: #333;
    }
    
    .wikidata-info .detail-definition {
      margin-top: 15px;
      padding: 15px;
      background-color: white;
      border-left: 4px solid #0078d7;
      border-radius: 4px;
      line-height: 1.8;
    }
    
    .wikidata-info .properties {
      margin-top: 15px;
    }
    
    .wikidata-info .property-item {
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .wikidata-info .property-item:last-child {
      border-bottom: none;
    }
    
    .btn {
      padding: 12px 24px;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      transition: all 0.3s;
      display: inline-block;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    
    .btn-primary {
      background-color: #0078d7;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #005fa3;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 8px;
      padding: 20px;
      color: #721c24;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="quiz-container">
  
  <!-- æƒ…å ±è¡¨ç¤º -->
  <div class="info">
    <div class="progress">
      <div>
        <strong>å­¦å¹´ï¼š</strong><span th:text="${grade}">å°3</span>
      </div>
      <div>
        <strong>å•é¡Œï¼š</strong>
        <span th:text="${currentIndex != null ? currentIndex + 1 : 1}">1</span> / 
        <span th:text="${totalQuestions != null ? totalQuestions : '?'}">5</span>
      </div>
    </div>
    <div>
      <strong>ç¾åœ¨ã®æ­£è§£æ•°ï¼š</strong>
      <span th:text="${correctCount != null ? correctCount : 0}">0</span> / 
      <span th:text="${totalCount != null ? totalCount : 0}">0</span>
    </div>
  </div>

  <!-- ã‚¯ã‚¤ã‚ºãŒå­˜åœ¨ã™ã‚‹å ´åˆ -->
  <div th:if="${quiz != null}">
    <h2>å•é¡Œ</h2>
    
    <div class="question" th:text="${quiz.question}">
      å•é¡Œæ–‡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
    </div>
    
    <ul class="choices" id="choicesList">
      <!-- JavaScriptã§ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã³æ›¿ãˆã‚‹ -->
    </ul>
    
    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="result" class="result hidden"></div>

    <!-- â˜… Wikidataæƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="wikidataInfo" class="wikidata-info hidden">
      <h3>è¿½åŠ æƒ…å ±</h3>
      <div id="wikidataContent"></div>
    </div>

    <!-- æ¬¡ã®å•é¡Œã¸ã®ãƒªãƒ³ã‚¯ï¼ˆhiddençŠ¶æ…‹ï¼‰ -->
    <div id="nextButtonDiv" class="hidden" style="margin-top: 20px;">
      <a href="#" id="nextButton" class="btn btn-primary">æ¬¡ã®å•é¡Œã¸ â†’</a>
    </div>
  </div>

  <!-- ã‚¯ã‚¤ã‚ºãŒç”Ÿæˆã§ããªã‹ã£ãŸå ´åˆ -->
  <div class="error" th:if="${quiz == null}">
    <h3>âš ï¸ ã‚¨ãƒ©ãƒ¼</h3>
    <p>ã‚¯ã‚¤ã‚ºã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
    <p><strong>åŸå› ï¼š</strong>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã€ã¾ãŸã¯OpenAI APIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
  </div>

  <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div style="margin-top: 20px;">
    <a href="/" class="btn btn-secondary">å­¦å¹´é¸æŠã«æˆ»ã‚‹</a>
  </div>

</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  
  // Thymeleafã‹ã‚‰å€¤ã‚’å–å¾—
  const choices = /*[[${quiz?.choices}]]*/ [];
  const correctIndex = /*[[${quiz?.answerIndex}]]*/ 0;
  const keyword = /*[[${keyword}]]*/ '';
  const grade = /*[[${grade}]]*/ '';
  const nextIndex = /*[[${index}]]*/ 1;
  
  // â˜… Wikidataæƒ…å ±ã‚’å–å¾—
  const wikidataInfo = /*[[${wikidataInfo}]]*/ null;
  
  // é¸æŠè‚¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã³æ›¿ãˆ
  const shuffledChoices = choices.map((choice, index) => ({
    text: choice,
    originalIndex: index
  }));
  
  // Fisher-Yates ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  for (let i = shuffledChoices.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledChoices[i], shuffledChoices[j]] = [shuffledChoices[j], shuffledChoices[i]];
  }
  
  // ç”»é¢ã«è¡¨ç¤º
  const choicesList = document.getElementById('choicesList');
  shuffledChoices.forEach((item, displayIndex) => {
    const li = document.createElement('li');
    const button = document.createElement('button');
    button.type = 'button';
    button.textContent = (displayIndex + 1) + '. ' + item.text;
    button.onclick = () => checkAnswer(item.originalIndex, correctIndex, button);
    li.appendChild(button);
    choicesList.appendChild(li);
  });
  
  function checkAnswer(selectedIndex, correctIndex, selectedButton) {
    const buttons = document.querySelectorAll('.choices button');
    buttons.forEach(btn => btn.disabled = true);
    
    const resultDiv = document.getElementById('result');
    const nextButtonDiv = document.getElementById('nextButtonDiv');
    const nextButton = document.getElementById('nextButton');
    const wikidataDiv = document.getElementById('wikidataInfo');
    const wikidataContent = document.getElementById('wikidataContent');
    
    const isCorrect = (selectedIndex === correctIndex);
    
    if (isCorrect) {
      selectedButton.classList.add('correct');
      resultDiv.className = 'result correct';
      resultDiv.textContent = 'âœ… æ­£è§£ã§ã™ï¼';
    } else {
      selectedButton.classList.add('wrong');
      buttons.forEach(btn => {
        const btnText = btn.textContent.substring(3);
        if (btnText === choices[correctIndex]) {
          btn.classList.add('correct');
        }
      });
      resultDiv.className = 'result wrong';
      resultDiv.textContent = 'âŒ ä¸æ­£è§£ã§ã™ã€‚æ­£è§£ã¯ã€Œ' + choices[correctIndex] + 'ã€ã§ã—ãŸã€‚';
    }
    
    resultDiv.classList.remove('hidden');
    
    // â˜… Wikidataæƒ…å ±ã‚’è¡¨ç¤º
    if (wikidataInfo) {
      displayWikidataInfo(wikidataInfo, wikidataContent);
      wikidataDiv.classList.remove('hidden');
    }
    
    // æ¬¡ã®å•é¡Œã¸ã®ãƒªãƒ³ã‚¯ã‚’è¨­å®š
    const encodedKeyword = encodeURIComponent(keyword);
    const encodedGrade = encodeURIComponent(grade);
    nextButton.href = `/quiz?keyword=${encodedKeyword}&grade=${encodedGrade}&index=${nextIndex}&isCorrect=${isCorrect}`;
    
    nextButtonDiv.classList.remove('hidden');
  }
  
  // â˜… Wikidataæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function displayWikidataInfo(info, container) {
    let html = '';
    
    // åç§°
    if (info.label) {
      html += `<div class="info-item"><span class="info-label">åç§°ï¼š</span><span class="info-value">${escapeHtml(info.label)}</span></div>`;
    }
    
    // ç°¡æ˜“èª¬æ˜
    if (info.description) {
      html += `<div class="info-item"><span class="info-label">èª¬æ˜ï¼š</span><span class="info-value">${escapeHtml(info.description)}</span></div>`;
    }
    
    // åˆ¥å
    if (info.aliases && info.aliases.length > 0) {
      html += `<div class="info-item"><span class="info-label">åˆ¥åï¼š</span><span class="info-value">${escapeHtml(info.aliases.join('ã€'))}</span></div>`;
    }
    
    // WikipediaæŠœç²‹ï¼ˆè©³ç´°å®šç¾©ï¼‰
    if (info.wikipediaExtract) {
      html += `<div class="detail-definition">${escapeHtml(info.wikipediaExtract)}</div>`;
    }
    
    // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æƒ…å ±
    if (info.properties && info.properties.length > 0) {
      html += '<div class="properties"><strong>è©³ç´°æƒ…å ±ï¼š</strong>';
      info.properties.forEach(prop => {
        html += `<div class="property-item"><span class="info-label">${escapeHtml(prop.name)}ï¼š</span><span class="info-value">${escapeHtml(prop.value)}</span></div>`;
      });
      html += '</div>';
    }
    
    container.innerHTML = html;
  }
  
  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }
  
  /*]]>*/
</script>

</body>
</html>
